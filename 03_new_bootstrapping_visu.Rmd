---
title: "03_new_bootstrapping_visu"
author: "Levente Ronai"
date: "2024-04-08"
output: html_document
  html_document:
   theme: spacelab
   code_download: true
   toc: true
   toc_float: true
editor_options: 
  chunk_output_type: inline
---

```{r, include=F}

options(scipen = 999)

suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(xts))
suppressPackageStartupMessages(library(psych))
suppressPackageStartupMessages(library(qgraph))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(lme4))
suppressPackageStartupMessages(library(lmerTest))
suppressPackageStartupMessages(library(sjPlot))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(car))
suppressPackageStartupMessages(library(broom))
suppressPackageStartupMessages(library(performance))
suppressPackageStartupMessages(library(lmeresampler))
suppressPackageStartupMessages(library(ggpattern))

```

import data

```{r}
dat_cleaned <- read_csv("data_processed/dat_cleaned.csv")

model_dat <- read.csv("data_processed/model_dat.csv")
```

```{r}

# m_baseline_ple_detrended <- readRDS("models/m_baseline_ple_detrended.rds")
# 
# boot_baseline_ple_detrended <-
#   bootstrap(
#     m_baseline_ple_detrended,
#     .f = fixef,
#     type = "wild",
#     hccme =  "hc2",
#     aux.dist = "mammen",
#     B = 5000 ,
#     resample = c(TRUE, TRUE)
#   )
# 
# saveRDS(boot_baseline_ple_detrended, "models/boot_baseline_ple_detrended.rds")

boot_baseline_ple_detrended <- readRDS("models/boot_baseline_ple_detrended.rds")

```

```{r}
list_case_ple_baseline <- 
  list(boot_baseline_ple_detrended)
ci_boot_baseline_ple_detrended <-
  list_case_ple_baseline %>%
  map(confint, type = "norm")


as.data.frame(ci_boot_baseline_ple_detrended) %>% print.data.frame(., digits = 2)

```

```{r}

# m_baseline_event_detrended <- readRDS("models/m_baseline_event_detrended.rds")
# 
# boot_baseline_event_detrended <-
#   bootstrap(
#     m_baseline_event_detrended,
#     .f = fixef,
#     type = "wild",
#     hccme =  "hc2",
#     aux.dist = "mammen",
#     B = 5000 ,
#     resample = c(TRUE, TRUE)
#   )
# 
# saveRDS(boot_baseline_event_detrended, "models/boot_baseline_event_detrended.rds")

boot_baseline_event_detrended <- readRDS("models/boot_baseline_event_detrended.rds")

```

```{r}
list_case_event_baseline <- 
  list(boot_baseline_event_detrended)
ci_boot_baseline_event_detrended <-
  list_case_event_baseline %>%
  map(confint, type = "norm")
as.data.frame(ci_boot_baseline_event_detrended) %>% print.data.frame(., digits = 2)

```

```{r}

# m3 <- readRDS("models/m3.rds")
# 
# boot_m3 <-
#   bootstrap(
#     m3,
#     .f = fixef,
#     type = "wild",
#     hccme =  "hc2",
#     aux.dist = "mammen",
#     B = 5000 ,
#     resample = c(TRUE, TRUE)
#   )
# 
# saveRDS(boot_m3, "models/boot_m3.rds")

boot_m3 <- readRDS("models/boot_m3.rds")
```

```{r}
list_case_m3 <- 
  list(boot_m3)
ci_boot_m3 <-
  list_case_m3 %>%
  map(confint, type = "norm")
as.data.frame(ci_boot_m3) %>% print.data.frame(., digits = 2)

```

```{r}
m9 <- readRDS("models/m9.rds")

boot_m9 <-
  bootstrap(
    m9,
    .f = fixef,
    type = "wild",
    hccme =  "hc2",
    aux.dist = "mammen",
    B = 5000 ,
    resample = c(TRUE, TRUE)
  )

saveRDS(boot_m9, "models/boot_m9.rds")

boot_m9 <- readRDS("models/boot_m9.rds")

```

```{r}
list_case_m9 <- 
  list(boot_m9)

ci_boot_m9 <-
  list_case_m9 %>%
  map(confint, type = "norm")
as.data.frame(ci_boot_m9) %>% print.data.frame(., digits = 2)

```

```{r}
# extracting results into a tibble

boot_dat_mod_3 <- 
  list_case_m3 %>% 
  map("replicates") %>% 
  
map(
    ~tibble(
      Stress_Main = na.omit(.x$stressor_mean_centered_int),
      Disorganized_Main = na.omit(.x$mss_dis_score),
      Positive_Main = na.omit(.x$mss_pos_score),
      Negative_Main = na.omit(.x$mss_neg_score),
      Disorganized_Stress_Interaction = na.omit(.x$"stressor_mean_centered_int:mss_dis_score"),
      Positive_Stress_Interaction = na.omit(.x$"stressor_mean_centered_int:mss_pos_score"),
      Negative_Stress_Interaction = na.omit(.x$"stressor_mean_centered_int:mss_neg_score")
      
    )
  ) %>%
  bind_rows() %>% 
  mutate(main_diff_dispos = Disorganized_Main - Positive_Main,
         int_diff_dispos = Disorganized_Stress_Interaction - Positive_Stress_Interaction,
         main_diff_disneg = Disorganized_Main - Negative_Main,
         int_diff_disneg = Disorganized_Stress_Interaction - Negative_Stress_Interaction)
  
```


```{r}
boot_dat_mod_3 <- 
  boot_dat_mod_3%>%
  select(-Stress_Main)
  
boot_dat_mod_long_3 <- 
  boot_dat_mod_3 %>%
    pivot_longer(c(
    Disorganized_Main, 
    Positive_Main,
    Negative_Main,
    Disorganized_Stress_Interaction,
    Positive_Stress_Interaction,
    Negative_Stress_Interaction,
    main_diff_dispos,
    int_diff_dispos,
    main_diff_disneg,
    int_diff_disneg), names_to = "predictor", values_to = "value")
  
  
boot_dat_mod_long_3 <- 
  boot_dat_mod_long_3 %>% 
  mutate(color = ifelse((predictor == "Disorganized_Main" & value > 0),
                        "diz",
                        ifelse((predictor == "Positive_Main" & value > 0),
                               "poz",
                        ifelse((predictor == "Negative_Main" & value > 0),
                               "neg",
                        ifelse((predictor == "main_diff_dispos" & value > 0),
                               "diz",
                        ifelse((predictor == "int_diff_dispos" & value > 0),
                               "diz",
                        ifelse((predictor == "main_diff_dispos" & value < 0),
                               "poz",
                        ifelse((predictor == "int_diff_dispos" & value < 0),
                               "poz",
                        ifelse((predictor == "main_diff_disneg" & value > 0),
                               "diz",
                        ifelse((predictor == "int_diff_disneg" & value > 0),
                               "diz",
                        ifelse((predictor == "main_diff_disneg" & value < 0),
                               "neg",
                        ifelse((predictor == "int_diff_disneg" & value < 0),
                               "neg",
                        ifelse((predictor == "Disorganized_Stress_Interaction" & value > 0),
                               "diz",
                        ifelse((predictor == "Positive_Stress_Interaction" & value > 0),
                               "poz",
                        ifelse((predictor == "Negative_Stress_Interaction" & value > 0),
                               "neg",
                               "graj"))))))))))))))) %>% 
  mutate(color = factor(color, levels = c("diz", "neg", "poz", "graj"), labels = c("#1B9E77", "#7570B3", "#d95f02","#6E6E6E")))

```




```{r}

pred_names <- c(
  
  Disorganized_Main = "In predicting momentary PLEs",
  Positive_Main = "",
  Negative_Main = "",
  main_diff_dispos = "",
  main_diff_disneg = "In predicting momentary PLEs",
  Disorganized_Stress_Interaction = "In predicting momentary PLE-reactivity",
  Positive_Stress_Interaction = "",
  Negative_Stress_Interaction = "",
  int_diff_dispos = "",
  int_diff_disneg = "In predicting momentary PLE-reactivity")



boot_dat_mod_long_3 %>%
  filter(predictor != "int_diff_dispos" & predictor != "main_diff_dispos" & predictor != "int_diff_disneg" & predictor != "main_diff_disneg") %>%
  ggplot(aes(x = value)) +
  geom_histogram(aes(fill = color), binwidth = 0.01) + #, breaks = seq(-0.15, 0.15, by = 0.005)) +

  theme_minimal() + 
  # theme(legend.key.size = unit(3, 'lines'),
  #                         legend.key = element_rect(size = 10, color = "white")) +
  
  facet_wrap(vars(predictor), ncol = 2, labeller = as_labeller(pred_names)) +
  labs(x = "Bootstrapped estimates of multilevel model coefficients",
       y = "Frequencies") +
scale_fill_manual(values = alpha(c("#1B9E77", "#7570B3", "#d95f02"), 0.8), limits = c("#1B9E77", "#7570B3", "#d95f02"), labels = c("Disorganized","Negative",  "Positive")) +
  guides(fill = guide_legend(title = "Positive coef.:")) +
  geom_vline(xintercept = 0, color = "black", size = 1)



```

```{r}
boot_dat_mod_long_3 %>%
  filter(predictor == "int_diff_dispos" | predictor == "main_diff_dispos" | predictor == "int_diff_disneg" | predictor == "main_diff_disneg") %>%
  ggplot(aes(x = value)) +
  geom_histogram(aes(fill = color), binwidth = 0.02) + #, breaks = seq(-0.15, 0.15, by = 0.005)) +
  theme_minimal() +
  facet_wrap(vars(predictor), ncol = 2, labeller = as_labeller(pred_names)) +
  labs(x = bquote(~ italic("Differences") ~ "between single bootstrapped estimates of model coefficents"),
       y = "Frequencies") +
  
#  labs(x = "Distriibution of differences between bootstrapped estimates", y = "Freqiencies") +
# ggtitle("Differences between bootstrapped estimates of disorg. and positive domain") +
scale_fill_manual(values = alpha(c("#1B9E77", "#7570B3", "#d95f02"), 0.8), limits = c("#1B9E77", "#7570B3", "#d95f02"), labels = c("Disorganized","Negative",  "Positive")) +  guides(fill = guide_legend(title = "Stronger predictor:")) +
  geom_vline(xintercept = 0, color = "black", size = 1.15)

```


```{r}

boot_dat_mod_long_3 %>% 
  filter(predictor == "int_diff_dispos") %>%
  mutate(perc = ifelse(value > 0,
                       "diz",
                       "pos")) %>%
  select(perc) %>% 
  table() %>% 
  prop.table() %>% `*`(100) %>% round(0)

boot_dat_mod_long_3 %>% 
  filter(predictor == "main_diff_dispos") %>%
  mutate(perc = ifelse(value > 0,
                       "diz",
                       "pos")) %>%
  
  select(perc) %>% 
  table() %>% 
  prop.table() %>% `*`(100) %>% round(0)

```

```{r}

boot_dat_mod_long_3 %>% 
  filter(predictor == "main_diff_disneg") %>%
  mutate(perc = ifelse(value > 0,
                       "diz",
                       "neg")) %>%
  
  select(perc) %>% 
  table() %>% 
  prop.table() %>% `*`(100) %>% round(0)

boot_dat_mod_long_3 %>% 
  filter(predictor == "int_diff_disneg") %>%
  mutate(perc = ifelse(value > 0,
                       "diz",
                       "neg")) %>%
  select(perc) %>% 
  table() %>% 
  prop.table() %>% `*`(100) %>% round(0)

```

```{r}
# extracting results into a tibble

boot_dat_mod_9 <- 
  list_case_m9 %>% 
  map("replicates") %>% 
  
map(
    ~tibble(
      Stress_Main = na.omit(.x$stressor_mean_centered_int),
      Disorganized_Main = na.omit(.x$mss_dis_score),
      Positive_Main = na.omit(.x$mss_pos_score),
      Negative_Main = na.omit(.x$mss_neg_score),
      Disorganized_Stress_Interaction = na.omit(.x$"stressor_mean_centered_int:mss_dis_score"),
      Positive_Stress_Interaction = na.omit(.x$"stressor_mean_centered_int:mss_pos_score"),
      Negative_Stress_Interaction = na.omit(.x$"stressor_mean_centered_int:mss_neg_score")
      
    )
  ) %>%
  bind_rows() %>% 
  mutate(main_diff_dispos = Disorganized_Main - Positive_Main,
         int_diff_dispos = Disorganized_Stress_Interaction - Positive_Stress_Interaction,
         main_diff_disneg = Disorganized_Main - Negative_Main,
         int_diff_disneg = Disorganized_Stress_Interaction - Negative_Stress_Interaction)
  
```


```{r}
boot_dat_mod_9 <- 
  boot_dat_mod_9 %>%
  select(-Stress_Main)
  
boot_dat_mod_long_9 <- 
  boot_dat_mod_9 %>%
    pivot_longer(c(
    Disorganized_Main, 
    Positive_Main,
    Negative_Main,
    Disorganized_Stress_Interaction,
    Positive_Stress_Interaction,
    Negative_Stress_Interaction,
    main_diff_dispos,
    int_diff_dispos,
    main_diff_disneg,
    int_diff_disneg), names_to = "predictor", values_to = "value")
  
  
boot_dat_mod_long_9 <- 
  boot_dat_mod_long_9 %>% 
  mutate(color = ifelse((predictor == "Disorganized_Main" & value > 0),
                        "diz",
                        ifelse((predictor == "Positive_Main" & value > 0),
                               "poz",
                        ifelse((predictor == "Negative_Main" & value > 0),
                               "neg",
                        ifelse((predictor == "main_diff_dispos" & value > 0),
                               "diz",
                        ifelse((predictor == "int_diff_dispos" & value > 0),
                               "diz",
                        ifelse((predictor == "main_diff_dispos" & value < 0),
                               "poz",
                        ifelse((predictor == "int_diff_dispos" & value < 0),
                               "poz",
                        ifelse((predictor == "main_diff_disneg" & value > 0),
                               "diz",
                        ifelse((predictor == "int_diff_disneg" & value > 0),
                               "diz",
                        ifelse((predictor == "main_diff_disneg" & value < 0),
                               "neg",
                        ifelse((predictor == "int_diff_disneg" & value < 0),
                               "neg",
                        ifelse((predictor == "Disorganized_Stress_Interaction" & value > 0),
                               "diz",
                        ifelse((predictor == "Positive_Stress_Interaction" & value > 0),
                               "poz",
                        ifelse((predictor == "Negative_Stress_Interaction" & value > 0),
                               "neg",
                               "graj"))))))))))))))) %>% 
  mutate(color = factor(color, levels = c("diz", "neg", "poz", "graj"), labels = c("#1B9E77", "#7570B3", "#d95f02","#6E6E6E")))

```




```{r}

pred_names <- c(
  
  Disorganized_Main = "In predicting momentary event-unpleasantness",
  Positive_Main = "",
  Negative_Main = "",
  main_diff_dispos = "",
  main_diff_disneg = "In predicting momentary event-unpleasantness",
  Disorganized_Stress_Interaction = "In predicting momentary stress-reactivity",
  Positive_Stress_Interaction = "",
  Negative_Stress_Interaction = "",
  int_diff_dispos = "",
  int_diff_disneg = "In predicting momentary stress-reactivity")



boot_dat_mod_long_9 %>%
  filter(predictor != "int_diff_dispos" & predictor != "main_diff_dispos" & predictor != "int_diff_disneg" & predictor != "main_diff_disneg") %>%
  ggplot(aes(x = value)) +
  geom_histogram(aes(fill = color), binwidth = 0.01) + #, breaks = seq(-0.15, 0.15, by = 0.005)) +

  theme_minimal() + 
  # theme(legend.key.size = unit(3, 'lines'),
  #                         legend.key = element_rect(size = 10, color = "white")) +
  
  facet_wrap(vars(predictor), ncol = 2, labeller = as_labeller(pred_names)) +
  labs(x = "Bootstrapped estimates of multilevel model coefficients",
       y = "Frequencies") +
scale_fill_manual(values = alpha(c("#1B9E77", "#7570B3", "#d95f02"), 0.8), limits = c("#1B9E77", "#7570B3", "#d95f02"), labels = c("Disorganized","Negative",  "Positive")) +
  guides(fill = guide_legend(title = "Positive coef.:")) +
  geom_vline(xintercept = 0, color = "black", size = 1.15)



```

```{r}
boot_dat_mod_long_9 %>%
  filter(predictor == "int_diff_dispos" | predictor == "main_diff_dispos" | predictor == "int_diff_disneg" | predictor == "main_diff_disneg") %>%
  ggplot(aes(x = value)) +
  geom_histogram(aes(fill = color), binwidth = 0.02) + #, breaks = seq(-0.15, 0.15, by = 0.005)) +
  theme_minimal() +
  facet_wrap(vars(predictor), ncol = 2, labeller = as_labeller(pred_names)) +
  labs(x = bquote(~ italic("Differences") ~ "between single bootstrapped estimates of model coefficents"),
       y = "Frequencies") +
  
#  labs(x = "Distriibution of differences between bootstrapped estimates", y = "Freqiencies") +
# ggtitle("Differences between bootstrapped estimates of disorg. and positive domain") +
scale_fill_manual(values = alpha(c("#1B9E77", "#7570B3", "#d95f02"), 0.8), limits = c("#1B9E77", "#7570B3", "#d95f02"), labels = c("Disorganized","Negative",  "Positive")) +  guides(fill = guide_legend(title = "Stronger predictor:")) +
  geom_vline(xintercept = 0, color = "black", size = 1.15)


```

```{r}
boot_dat_mod_long_9 %>% 
  filter(predictor == "main_diff_dispos") %>%
  mutate(perc = ifelse(value > 0,
                       "diz",
                       "pos")) %>%
  
  select(perc) %>% 
  table() %>% 
  prop.table() %>% `*`(100) %>% round(0)

boot_dat_mod_long_9 %>% 
  filter(predictor == "int_diff_dispos") %>%
  mutate(perc = ifelse(value > 0,
                       "diz",
                       "pos")) %>%
  select(perc) %>% 
  table() %>% 
  prop.table() %>% `*`(100) %>% round(0)
```


```{r}
boot_dat_mod_long_9 %>% 
  filter(predictor == "main_diff_disneg") %>%
  mutate(perc = ifelse(value > 0,
                       "diz",
                       "neg")) %>%
  
  select(perc) %>% 
  table() %>% 
  prop.table() %>% `*`(100) %>% round(0)

boot_dat_mod_long_9 %>% 
  filter(predictor == "int_diff_disneg") %>%
  mutate(perc = ifelse(value > 0,
                       "diz",
                       "neg")) %>%
  select(perc) %>% 
  table() %>% 
  prop.table() %>% `*`(100) %>% round(0)
```
