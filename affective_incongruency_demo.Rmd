---
title: "aff incongruency"
output: 
  html_document:
    toc: true
---


```{r, message=F, warning=F, include=F}

options(scipen = 999)

library(corrplot)
library(readxl)
library(xts)
library(psych)
library(qgraph)
library(tidyverse)
library(dplyr)
library(purrr)
library(lme4)
library(lmerTest)
library(lavaan)
library(sjPlot)
library(ggplot2)
library(car)
library(mlVAR)
library(graphicalVAR)
library(broom)
library(performance)
# library(confintr)
# library(goft)

```

### import data

```{r, message=F, warning=F}

model_dat <- read.csv("data_processed/model_dat.csv")

# model_dat <- 
#   model_dat %>%
#   filter_at(vars(event_unpleasantness_centered:ple_cfa_centered, negaff_cfa_centered_lag), all_vars(!is.na(.)))

```

### computing affective incongruency

```{r}
model_dat <- 
  model_dat %>% 
  group_by(id_esm) %>% 
  mutate(event_unpleasantness_z = scale(event_unpleasantness),
         negaff_cfa_lag_z = scale(negaff_cfa_lag),
         event_unpleasantness_lag_z = scale(event_unpleasantness_lag),
         negaff_cfa_z = scale(negaff_cfa)) %>% 
  ungroup() %>% 
  group_by(id_esm, day, beep) %>% 
  mutate(neg_incongruency = event_unpleasantness_z - negaff_cfa_lag_z, na.rm = T) %>% 
  
          # diff is pos --> high negative discrepancy in mood and stress-exposure (unexpected_worsening)
          # diff is neg --> high positive discrepancy in mood and stress-exposure (unexpected_brightening)
          # diff is 0 --> previously measured negaff is congruent with stress exposure

  ungroup() %>% 
  group_by(id_esm) %>%
  mutate(neg_incongruency_centered = scale(neg_incongruency, center = T, scale = F),
        
         
         
         aff_incongruency_centered = abs(neg_incongruency_centered),
         aff_incongruency = abs(neg_incongruency))

         # the difference is relevant not the valence

```

### distibutions of affective incongruency (abs), affective incongruency (raw, "neg_incongruency"), and others  

```{r, fig.height=6, fig.width=6, warning=F}
model_dat %>% 
  select(event_unpleasantness_z, negaff_cfa_lag_z, aff_incongruency, neg_incongruency) %>% 
  pivot_longer(cols = c(event_unpleasantness_z, negaff_cfa_lag_z, aff_incongruency, neg_incongruency),
               names_to = "Variable", values_to = "Value") %>% 
  ggplot(aes(Value)) +
  geom_histogram(alpha = 0.5, binwidth = 0.5, fill = "darkblue") +
  facet_wrap(~ Variable)
```

### mozaik  

```{r}

model_dat %>% 
  filter(neg_incongruency <= 4 & neg_incongruency >= -4) %>% 
  ggplot(aes(negaff_cfa_lag_z, event_unpleasantness_z, fill = aff_incongruency)) + 
  geom_tile(width = 0.5, height = 0.5) +
  
  labs(
    fill = "Aff Incongruency",
    x    = "Z negaff lagged",
    y    = "Z perceived distress"
    ) +
  
  scale_fill_gradient(low = "darkblue", high = "yellow") +
  theme_classic()
```

### predicting ple by aff incongr over grand centered means of perceived stress, negative affectivity and lagged momentary ple on a filtered data (see histograms)  

```{r}
m <- 
  lmer(
    ple_cfa ~ 
      day + beep + gender + age +
      aff_incongruency_centered + ple_cfa_centered_lag + 
      event_unpleasantness_grand_centered + negaff_between +
      (aff_incongruency_centered + ple_cfa_centered_lag | id_esm), data = model_dat %>% filter(neg_incongruency <= 4 & neg_incongruency >= -4))
```

### std coefs displayed

```{r}
tab_model(m, show.std = T)

```

```{r}
m_plot <- plot_model(m, type = "pred")

m_plot$aff_incongruency_centered

```

```{r}
plot_model(m, show.values = TRUE, value.offset = .3, type = "std",
           show.p = TRUE, value.size = 3, line.size = 0.5, dot.size = 1, digits = 3) + ylim(-.7, .7)

```

### predicting negaff (controlled for mean and momentary distress)

```{r}
m_neg <- 
  lmer(
    negaff_cfa ~  
      day + beep + gender + age +
      aff_incongruency_centered + event_unpleasantness_centered + negaff_cfa_centered_lag +
      event_unpleasantness_grand_centered +

      (aff_incongruency_centered + event_unpleasantness_centered + negaff_cfa_centered_lag | id_esm), data = model_dat %>% filter(neg_incongruency <= 4 & neg_incongruency >= -4))


### megn√©zni az AIC-BICeket, hogy a diffel vagy a laggolt na-val jobb a modell???
```
#### std coefs NOT displayed, since the criteria variable was log10 transformed

```{r}
tab_model(m_neg)
```

```{r}
m_neg_plot <- plot_model(m_neg, type = "pred")

m_neg_plot$aff_incongruency_centered

```


```{r}
plot_model(m_neg, show.values = TRUE, value.offset = .3, type = "std",
           show.p = TRUE, value.size = 3, line.size = 0.5, dot.size = 1, digits = 3) + ylim(-.7, .7)

```

```{r}
vif(m_neg)
```

```{r}

plot_model(m_neg, type = "diag")

```


### predicting posaff (controlled for mean and momentary distress)

```{r}
m_pos <- 
  lmer(
    posaff_cfa ~ 
      day + beep + gender + age +
      aff_incongruency_centered + event_unpleasantness_centered + posaff_cfa_centered_lag + 
      event_unpleasantness_grand_centered + 
      (aff_incongruency_centered + event_unpleasantness_centered + posaff_cfa_centered_lag | id_esm), data = model_dat %>% filter(neg_incongruency <= 4 & neg_incongruency >= -4))
```

### std coefs displayed

```{r}
tab_model(m_pos, show.std = T)
```

```{r}

m_pos_plot <- plot_model(m_pos, type = "pred")

m_pos_plot$aff_incongruency_centered


```

```{r}
plot_model(m_pos, show.values = TRUE, value.offset = .3, type = "std",
           show.p = TRUE, value.size = 3, line.size = 0.5, dot.size = 1, digits = 3) + ylim(-.6, .6)

```

```{r}
plot_model(m_pos, type = "diag")
```

```{r}
vif(m_pos)
```
```{r}
m <- 
  lmer(
    ple_cfa ~ 
      day + beep + gender + age +
      aff_incongruency_centered  * mss_dis_score  +
      aff_incongruency_centered  * mss_pos_score  +
      aff_incongruency_centered  * mss_neg_score  +
      # event_unpleasantness_grand_centered + negaff_between +
      ple_cfa_centered_lag + 
      (aff_incongruency_centered + ple_cfa_centered_lag| id_esm), data = model_dat)


tab_model(m)
plot_model(m, type = "int")
```
