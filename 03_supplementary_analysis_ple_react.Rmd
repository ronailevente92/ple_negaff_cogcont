---
title: "03_supplementary_analysis"
author: "Levente Ronai"
output: html_document
  html_document:
   theme: spacelab
   code_download: true
   toc: true
   toc_float: true
editor_options: 
  chunk_output_type: inline
---

# loading packages

```{r, include=F}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(sjPlot))
suppressPackageStartupMessages(library(lme4))
suppressPackageStartupMessages(library(psych))
suppressPackageStartupMessages(library(matrixStats))
suppressPackageStartupMessages(library(performance))
suppressPackageStartupMessages(library(lmerTest))
suppressPackageStartupMessages(library(nortest))
suppressPackageStartupMessages(library(car))
suppressPackageStartupMessages(library(lmeresampler))
suppressPackageStartupMessages(library(patchwork))
suppressPackageStartupMessages(library(gtsummary))
suppressPackageStartupMessages(library(ggrain))
suppressPackageStartupMessages(library(confintr))

options(scipen = 999)
```

reading saved models and data

```{r}

model_dat <- read.csv("data_processed/model_dat.csv")


m0 <- readRDS("models/m0.rds")
m0_alt <- readRDS("models/m0_alt.rds")
m1 <- readRDS("models/m1.rds")
m2 <- readRDS("models/m2.rds")
m3 <- readRDS("models/m3.rds")
m4 <- readRDS("models/m4.rds")

```

```{r}
tab_model(m0, m1, m2, digits = 5, show.std = T)
tab_model(m0_alt, m3, m4, digits = 5, show.std = T)
```

assumptions for m1

```{r }

check_collinearity(m1)

plot_model(m1, type = "diag")

# normality test for residuals
m1_residuals <- residuals(m1)
nortest::lillie.test(m1_residuals)

hist(m1_residuals)

# normality test for crtiteria
nortest::lillie.test(model_dat$ple_cfa)

```

assumptions for m2

```{r }

check_collinearity(m2)

plot_model(m2, type = "diag")

# normality test for residuals
m2_residuals <- residuals(m2)
nortest::lillie.test(m2_residuals)

hist(m2_residuals)

```

assumptions for m3

```{r }

check_collinearity(m3)
# check_model(baseline_model)
plot_model(m3, type = "diag")

# normality test for residuals
m3_residuals <- residuals(m3)
nortest::lillie.test(m3_residuals)

# normality test for crtiteria
nortest::lillie.test(model_dat$event_unpleasantness)

```

assumptions for m4

```{r }

check_collinearity(m4)
# check_model(baseline_model)
plot_model(m4, type = "diag")

# normality test for residuals
m4_residuals <- residuals(m4)
nortest::lillie.test(m4_residuals)

```

correlation between three-day self exposure to objectified and mean state behavioural measures of cognitive performance

```{r}
corr <-
  model_dat %>%
  dplyr::select(id_esm, diary_counter, event_unpleasantness_3days_mean, stressor_sum_centered_int) %>%
  distinct() %>%
  select(-id_esm, -diary_counter)

shapiro.test(corr$stressor_sum_centered_int)
shapiro.test(corr$event_unpleasantness_3days_mean)
# normality not assumed

cor.test(corr$event_unpleasantness_3days_mean, corr$stressor_sum_centered_int, method = "spearman")
```


```{r}
ci_cor(corr, probs = c(0.025, 0.975), method = "spearman", type = "bootstrap", boot_type = "norm")
```


```{r}
ggplot(corr, aes(event_unpleasantness_3days_mean, stressor_sum_centered_int)) +
  geom_point(alpha = 0.5, position = "jitter") +
  geom_smooth(method = "lm", fill = "#8fb9dc", color = "#609CCE") +
  theme_classic() +
  theme(axis.title = element_text(size = 12))

```

bootstrapping

```{r}
# boot_m0 <-
#   bootstrap(
#     m0,
#     .f = fixef,
#     type = "wild",
#     hccme =  "hc2",
#     aux.dist = "mammen",
#     B = 5000 ,
#     resample = c(TRUE, TRUE)
#   )
# saveRDS(boot_m0, "models/boot_m0.rds")
# 
# 
# boot_m0_alt <-
#   bootstrap(
#     m0_alt,
#     .f = fixef,
#     type = "wild",
#     hccme =  "hc2",
#     aux.dist = "mammen",
#     B = 5000 ,
#     resample = c(TRUE, TRUE)
#   )
# saveRDS(boot_m0_alt, "models/boot_m0_alt.rds")

```


```{r}
# boot_m1 <-
#   bootstrap(
#     m1,
#     .f = fixef,
#     type = "wild",
#     hccme =  "hc2",
#     aux.dist = "mammen",
#     B = 5000 ,
#     resample = c(TRUE, TRUE)
#   )
# saveRDS(boot_m1, "models/boot_m1.rds")
# 
# 
# boot_m2 <-
#   bootstrap(
#     m2,
#     .f = fixef,
#     type = "wild",
#     hccme =  "hc2",
#     aux.dist = "mammen",
#     B = 5000 ,
#     resample = c(TRUE, TRUE)
#   )
# saveRDS(boot_m2, "models/boot_m2.rds")
```


```{r}
# boot_m3 <-
#   bootstrap(
#     m3,
#     .f = fixef,
#     type = "wild",
#     hccme =  "hc2",
#     aux.dist = "mammen",
#     B = 5000 ,
#     resample = c(TRUE, TRUE)
#   )
# saveRDS(boot_m3, "models/boot_m3.rds")
# 
# 
# boot_m4 <-
#   bootstrap(
#     m4,
#     .f = fixef,
#     type = "wild",
#     hccme =  "hc2",
#     aux.dist = "mammen",
#     B = 5000 ,
#     resample = c(TRUE, TRUE)
#   )
# saveRDS(boot_m4, "models/boot_m4.rds")


```

reading bootstrap file and extracting results into a list

```{r}

boot_m0 <-  readRDS("models/boot_m0.rds")
boot_m0_alt <-  readRDS("models/boot_m0_alt.rds")
boot_m2 <- readRDS("models/boot_m2.rds")
boot_m3 <- readRDS("models/boot_m3.rds")
boot_m1 <- readRDS("models/boot_m1.rds")
boot_m4 <- readRDS("models/boot_m4.rds")


list_case_m0 <- 
  list(boot_m0)

list_case_m0_alt <- 
  list(boot_m0_alt)

list_case_m2 <- 
  list(boot_m2)

list_case_m3 <- 
  list(boot_m3)

list_case_m1 <- 
  list(boot_m1)

list_case_m4 <- 
  list(boot_m4)
```

extracting bootstrapped coefficients

```{r paged.print=TRUE}
ci_boot_m0 <-
  list_case_m0 %>%
  map(confint, type = "norm")

ci_boot_m0_alt <-
  list_case_m0_alt %>%
  map(confint, type = "norm")

ci_boot_m1 <-
  list_case_m1 %>%
  map(confint, type = "norm")

ci_boot_m2 <-
  list_case_m2 %>%
  map(confint, type = "norm")

ci_boot_m3 <-
  list_case_m3 %>%
  map(confint, type = "norm")


ci_boot_m4 <-
  list_case_m4 %>%
  map(confint, type = "norm")
```


```{r paged.print=TRUE}
as.data.frame(ci_boot_m0) %>% print.data.frame(., digits = 2)
as.data.frame(ci_boot_m0_alt) %>% print.data.frame(., digits = 2)

as.data.frame(ci_boot_m1) %>% print.data.frame(., digits = 2)
as.data.frame(ci_boot_m2) %>% print.data.frame(., digits = 2)


as.data.frame(ci_boot_m3) %>% print.data.frame(., digits = 2)
as.data.frame(ci_boot_m4) %>% print.data.frame(., digits = 2)

```

visualization of raw and bootstrapped model estimates

### model 1

```{r echo=TRUE}
# extracting results into a tibble
boot_dat_mod_1_main <- 
  list_case_m1 %>% 
  map("replicates") %>% 
  
map(
    ~tibble(
    #  perceived_distress = na.omit(.x$stressor_sum_centered_int),
      Positive = na.omit(.x$mss_pos_score),
      Negative = na.omit(.x$mss_neg_score)
    )
  ) %>%
  bind_rows()

# rearranging tibble format
boot_dat_mod_1_main_long <- 
  boot_dat_mod_1_main %>% 
  pivot_longer(c(Positive, Negative), names_to = "predictor", values_to = "value")

boot_dat_mod_1_inter <- 
  list_case_m1 %>% 
  map("replicates") %>% 
  map(
    ~tibble(
      Positive = na.omit(.x$"stressor_sum_centered_int:mss_neg_score"),
      Negative = na.omit(.x$"stressor_sum_centered_int:mss_pos_score")
    )
  ) %>%
  bind_rows()

# rearranging tibble format
boot_dat_mod_1_inter_long <- 
  boot_dat_mod_1_inter %>% 
  pivot_longer(c(Positive, Negative), names_to = "predictor", values_to = "value")
```

### model 2

```{r echo=TRUE}
boot_dat_mod_2_main <- 
  list_case_m2 %>% 
  map("replicates") %>% 
  
map(
    ~tibble(
    #  perceived_distress = na.omit(.x$stressor_sum_centered_int),
      Positive = na.omit(.x$mss_pos_score),
      Negative = na.omit(.x$mss_neg_score),
      Disorganized = na.omit(.x$mss_dis_score)
    )
  ) %>%
  bind_rows()

# rearranging tibble format
boot_dat_mod_2_main_long <- 
  boot_dat_mod_2_main %>% 
  pivot_longer(c(Positive, Negative, Disorganized), names_to = "predictor", values_to = "value")

boot_dat_mod_2_inter <- 
  list_case_m2 %>% 
  map("replicates") %>% 
  map(
    ~tibble(
      Negative = na.omit(.x$"stressor_sum_centered_int:mss_neg_score"),
      Positive = na.omit(.x$"stressor_sum_centered_int:mss_pos_score"),
      Disorganized = na.omit(.x$"stressor_sum_centered_int:mss_dis_score")
    )
  ) %>%
  bind_rows()

# rearranging tibble format
boot_dat_mod_2_inter_long <- 
  boot_dat_mod_2_inter %>% 
  pivot_longer(c(Negative, Positive, Disorganized), names_to = "predictor", values_to = "value")
```

### model 3

```{r echo=TRUE}
boot_dat_mod_3_main <- 
  list_case_m3 %>% 
  map("replicates") %>% 
  
map(
    ~tibble(
    #  perceived_distress = na.omit(.x$stressor_sum_centered_int),
      Positive = na.omit(.x$mss_pos_score),
      Negative = na.omit(.x$mss_neg_score),
    )
  ) %>%
  bind_rows()

# rearranging tibble format
boot_dat_mod_3_main_long <- 
  boot_dat_mod_3_main %>% 
  pivot_longer(c(Positive, Negative), names_to = "predictor", values_to = "value")

boot_dat_mod_3_inter <- 
  list_case_m3 %>% 
  map("replicates") %>% 
  map(
    ~tibble(
      Negative = na.omit(.x$"stressor_sum_centered_int:mss_neg_score"),
      Positive = na.omit(.x$"stressor_sum_centered_int:mss_pos_score"),
    )
  ) %>%
  bind_rows()

# rearranging tibble format
boot_dat_mod_3_inter_long <- 
  boot_dat_mod_3_inter %>% 
  pivot_longer(c(Negative, Positive), names_to = "predictor", values_to = "value")
```

### model 4

```{r echo=TRUE}
boot_dat_mod_4_main <- 
  list_case_m4 %>% 
  map("replicates") %>% 
  
map(
    ~tibble(
    #  perceived_distress = na.omit(.x$stressor_sum_centered_int),
      Positive = na.omit(.x$mss_pos_score),
      Negative = na.omit(.x$mss_neg_score),
      Disorganized = na.omit(.x$mss_dis_score)
    )
  ) %>%
  bind_rows()

# rearranging tibble format
boot_dat_mod_4_main_long <- 
  boot_dat_mod_4_main %>% 
  pivot_longer(c(Positive, Negative, Disorganized), names_to = "predictor", values_to = "value")

boot_dat_mod_4_inter <- 
  list_case_m4 %>% 
  map("replicates") %>% 
  map(
    ~tibble(
      Negative = na.omit(.x$"stressor_sum_centered_int:mss_neg_score"),
      Positive = na.omit(.x$"stressor_sum_centered_int:mss_pos_score"),
      Disorganized = na.omit(.x$"stressor_sum_centered_int:mss_dis_score")
    )
  ) %>%
  bind_rows()

# rearranging tibble format
boot_dat_mod_4_inter_long <- 
  boot_dat_mod_4_inter %>% 
  pivot_longer(c(Negative, Positive, Disorganized), names_to = "predictor", values_to = "value")
```

```{r}

library(RColorBrewer)
# display.brewer.all()

colors <- brewer.pal(4, "Dark2")

```

```{r}
boot_plot_1_b <- 
  ggplot(boot_dat_mod_2_inter_long, aes(x = predictor, y = value, fill = predictor)) +
  geom_violin(color = NA, alpha = 0.5)+
  geom_boxplot(width = 0.2, fill = NA, outlier.shape = NA, lwd = 0.6) + 
  theme_classic() +
  scale_fill_brewer(palette = 'Dark2') +
  guides(fill = 'none', color = 'none') +
  geom_hline(yintercept = 0, color = "black", linetype = 2, alpha = .4, size = .7) +
  labs(
       x  = "",
       y = "Bootstrapped Interaction\nEstimates",
       title = "",
       )
```

```{r}
boot_plot_2 <- 
  ggplot(boot_dat_mod_4_inter_long, aes(x = predictor, y = value, fill = predictor)) +
	 geom_violin(color = NA, alpha = 0.5)+
  geom_boxplot(width = 0.2, fill = NA, outlier.shape = NA, lwd = 0.6) + 
  theme_classic() +
  scale_fill_brewer(palette = 'Dark2') +
  guides(fill = 'none', color = 'none') +
  geom_hline(yintercept = 0, color = "black", linetype = 2, alpha = .4, size = .7) +
  labs(
       x  = "",
       y = "",
       title = "",
       )

```

```{r}
neg_m2 <- plot_model(m2, type = "int")[[1]]
pos_m2 <- plot_model(m2, type = "int")[[2]]
dis_m2 <- plot_model(m2, type = "int")[[3]]

neg_m4 <- plot_model(m4, type = "int")[[1]]
pos_m4 <- plot_model(m4, type = "int")[[2]]
dis_m4 <- plot_model(m4, type = "int")[[3]]
```

```{r, warning=F}

dis_m2 <- 
  dis_m2 +
  geom_smooth(size = 1.3) +
  scale_fill_manual(values = c("black", "#1B9E77")) +
  scale_colour_manual(labels = c("Low", "High"), values = c("black", "#1B9E77")) + 
  theme_classic() +
  theme(legend.position='none') +

  labs(
       x  = "Stress-exposure",
       y = "",
       color = "Disorg.:",
       title = "",
       ) 

pos_m2 <- 
  pos_m2 + 
  geom_smooth(size = 1.3) + 
  scale_fill_manual(values = c("black", "#7570B3")) +
  scale_colour_manual(labels = c("Low", "High"), values = c("black", "#7570B3")) + 
  theme_classic() +
  theme(legend.position='none') +

  labs(
       x  = "",
       y = "",
       color = "Positive:",
       title = "",
       )

neg_m2_b <- 
  neg_m2 + 
  geom_smooth(size = 1.3) + 
  scale_fill_manual(values = c("black", "#d95f02")) +
  scale_colour_manual(labels = c("Low", "High"), values = c("black", "#d95f02")) + 
  theme_classic() +
  theme(legend.position='none') +
  labs(
       x  = "",
       y = "",
       color = "Negative:",
       title = bquote("Prediction of" ~ italic("PLE (log10)"))) +
  theme(plot.title = element_text(hjust = 0.5))

dis_m4 <- 
  dis_m4 +
  geom_smooth(size = 1.3) + 
  scale_fill_manual(values = c("black", "#1B9E77")) +
  scale_colour_manual(labels = c("Low", "High"), values = c("black", "#1B9E77")) + 
  theme_classic() +

  labs(
       x  = "Stress-exposure",
       y = "",
       color = "Disorg.:",
       title = "",
       ) 

pos_m4 <- 
  pos_m4 + 
  geom_smooth(size = 1.3) + 
  scale_fill_manual(values = c("black", "#7570B3")) +
  scale_colour_manual(labels = c("Low", "High"), values = c("black", "#7570B3")) + 
  theme_classic() +
  labs(
       x  = "",
       y = "",
       color = "Positive:",
       title = "",
       )

neg_m4_b <- 
  neg_m4 + 
  geom_smooth(size = 1.3) + 
  scale_fill_manual(values = c("black", "#d95f02")) +
  scale_colour_manual(labels = c("Low", "High"), values = c("black", "#d95f02")) + 
  theme_classic() +
  labs(
       x  = "",
       y = "",
       color = "Negative:",
   #    title = "In predicting PLE (log10 transformed)",
       title = bquote("Prediction of " ~ italic("\nEvent-unpleasantness"))) +
  theme(plot.title = element_text(hjust = 0.5))

```

```{r, warning=F, message=F}

# add "fig.height=7, fig.width=5" to better visualization

combined_plots <- 
  neg_m2_b + neg_m4_b + 
  pos_m2 + pos_m4 + 
  dis_m2 + dis_m4 + 
  boot_plot_1_b + 
  boot_plot_2 + 
  plot_layout(ncol = 2, nrow = 4, heights = c(1.2, 1.2, 1.2, 2))+ #, widths = c(1.2, 1.2, 1.2, 2)) + 
  plot_annotation(tag_levels = "A") & 
  theme(
    plot.title = element_text(size = 10),
    plot.tag = element_text(size = 10, face="bold"),
   # legend.position = "bottom",
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 7),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8))


combined_plots

ggsave("Fig02.jpeg", device = "jpeg", width = 15, height = 20, units = "cm")

```


```{r}

model_dat %>% 
  select(id_esm, mss_dis, mss_pos, mss_neg) %>% 
  distinct() %>% 
  gather("dimension", "value", 2:4) %>%
  
  ggplot(aes(dimension, value)) +
  
  ggdist::stat_halfeye(aes(fill = factor(dimension)), adjust = 1.5, width = .8, .width = 0, justification = -.18, point_colour = NA, position = position_dodge(width = 0.8), width = 0.25) + 
  geom_boxplot(width = .21, outlier.shape = NA, lwd = 0.6, position = position_dodge(width = 0.8), width = 0.25) + 
  geom_jitter(aes(color = factor(dimension)), width = .05, height = 0.1, alpha = .2, show.legend = F) +

 # facet_wrap(~dimension, dir = "v") +   #, scales = "free", dir = "v") +
  theme(strip.text.x = element_blank(),
        legend.spacing.y = unit(1, 'cm')) +
  guides(fill = guide_legend(byrow = TRUE)) + 
  xlab("") +
  ylab("Total raw scores") +
  labs(fill = "Schizotypal dim.:", title = "") + 
  scale_y_continuous(limits = c(0, 14), breaks = c(0, 2, 4, 6, 8, 10, 12, 14)) +
  theme_classic() +
  #+ 
  scale_fill_manual(labels = c("Disorganized", "Negative", "Positive"), values = c("#1B9E77", "#d95f02", "#7570B3")) +
  scale_color_manual(labels = c("Disorganized", "Negative", "Positive"), values = c("#1B9E77", "#d95f02", "#7570B3")) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
  
  ggsave("distr.jpeg", device = "jpeg", width = 15, height = 9, units = "cm")

```



